<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tronprotocol.github.io/documentation-zh/mechanism-algorithm/dex/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>去中心化交易所 - java-tron</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u53bb\u4e2d\u5fc3\u5316\u4ea4\u6613\u6240";
        var mkdocs_page_input_path = "mechanism-algorithm/dex.md";
        var mkdocs_page_url = "/documentation-zh/mechanism-algorithm/dex/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> java-tron
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">java-tron入门</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started_with_javatron/">入门</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">使用java-tron</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/installing_javatron/">部署</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/backup_restore/">备份和恢复</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/litefullnode/">轻节点</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/private_network/">私链网络</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/event/">事件订阅</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/database/">数据库配置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/connecting_to_tron/">网络连接</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/metrics/">节点监控</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/toolkit/">节点维护工具</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API接口</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/http/">HTTP 接口</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/rpc/">gRPC 接口</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/json-rpc/">jsonRPC 接口</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">核心协议</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../dpos/">波场共识</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../sr/">超级代表</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../account/">账户模型</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../resource/">资源模型</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/contract/">智能合约</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system-contracts/">系统合约</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">去中心化交易所</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">什么是交易对</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">创建交易对</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_4">交易</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">注资</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_6">撤资</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_7">查询</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1">1. 查询交易</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2">2. 计算当前价格</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-token">3. 计算交易获得token量</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../multi-signatures/">账户权限管理</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">java-tron开发</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/java-tron/">开发者指南</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/tips/">TIPs工作流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/issue-workflow/">Issue工作流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/governance/">治理流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/run-in-idea/">配置IDE开发环境</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/demo/">开发示例</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/code-structure/">核心模块</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Dapp开发</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/tools/">工具</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">客户端</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli/">wallet-cli</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">版本发布</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/upgrade-instruction/">新版本部署手册</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/signature_verification/">一致性检验</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/history/">历史版本</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">附录</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../glossary/">术语表</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">java-tron</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">核心协议</li>
      <li class="breadcrumb-item active">去中心化交易所</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/tronprotocol/documentation-zh/edit/master/docs/mechanism-algorithm/dex.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">去中心化交易所<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="_2">什么是交易对<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>TRON网络原生支持去中心化交易所(DEX)。去中心化交易所由多个交易对构成。一个交易对（Exchange）是token与token之间，或者token与TRX之间的交易市场（Exchange Market）。
任何账户都可以创建任何token之间的交易对，即使TRON网络中已经存在相同的交易对。交易对的买卖与价格波动遵循Bancor协议。
TRON网络规定，所有交易对中的两个token的权重相等，因此它们数量（balance）的比率即是它们之间的价格。
举一个简单的例子，假设一个交易对包含ABC和DEF两种token，ABC的balance为1000万，DEF的balance为100万，由于权重相等，因此10 ABC = 1 DEF，也就是说，当前ABC对于DEF的价格为10ABC/DEF。</p>
<h2 id="_3">创建交易对<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>任何账户都可以创建任何token之间的交易对。创建交易对的手续费是1024TRX，这个手续费会被TRON网络烧掉。
创建交易对相当于为该交易对注入（inject）原始资本，因此创建者账户中要拥有该交易对的初始balance。当创建成功后，会立即从创建者账户中扣除这两个token的balance。</p>
<p>创建交易对的合约是ExchangeCreateContract，该合约有4个参数：</p>
<ul>
<li>first_token_id，第1种token的id</li>
<li>first_token_balance，第1种token的balance</li>
<li>second_token_id，第2种token的id</li>
<li>second_token_balance，第2种token的balance</li>
</ul>
<p>如果交易对中包含TRX，则使用" _ "表示TRX的id。需要注意的是，TRX的单位是SUN。
例子：</p>
<div class="highlight"><pre><span></span><code>ExchangeCreate<span class="w"> </span>abc<span class="w"> </span><span class="m">10000000</span><span class="w"> </span>_<span class="w"> </span><span class="m">1000000000000</span>
</code></pre></div>
<p>该交易会创建abc与TRX之间的交易对，初始balance分别为10000000个abc和1000000000000 sun（1000000TRX），
如果创建者没有足够的abc和TRX，则交易对创建失败；否则创建者账户中立即扣除相应的abc和TRX，交易对创建成功，可以开始交易。</p>
<h2 id="_4">交易<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>任何账户都可以在任何交易对中进行交易。交易量和价格完全遵循Bancor协议。也就是说，一个账户在交易时，交易的对象是exchange。交易是即时的，不需要挂单和抢单，只要有足够的token，就可以交易成功。</p>
<p>交易的合约是ExchangeTransactionContract，该合约有3个参数：</p>
<ul>
<li>exchange_id，交易对的id，TRON网络会根据交易对创建时间顺序给每个交易对唯一的id</li>
<li>token_id，要卖出的token的id</li>
<li>quant，要卖出的token的金额</li>
<li>expected，期望得到的另一个token的最小金额。如果小于此数值，交易不会成功</li>
</ul>
<p>例子：
我们在刚刚创建的abc与TRX的交易对中进行交易，假设此交易对id为1，当前交易对中abc balance为10000000，TRX balance为1000000，如果期望花100个TRX买到至少990个abc，则</p>
<div class="highlight"><pre><span></span><code>ExchangeTransaction<span class="w"> </span><span class="m">1</span><span class="w"> </span>_<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">990</span>
</code></pre></div>
<p>其中" _ "表示TRX，即向交易对卖出100个TRX。如果成功，该交易会使得交易对中增加100个TRX，并根据Bancor协议计算出减少的abc的数量，交易创建者的账户中abc和TRX的数量会相应地增加和减少。实际交易到的abc数量，通过transaction result的exchange_received_amount字段返回，可以通过gettransactioninfobyid查询。</p>
<h2 id="_5">注资<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>当一个交易对其中1种token的balance很小时，只需要很小的交易量就会造成很大的价格波动，这不利于正常交易。为了避免这种情况，该交易对的创建者可以选择向该交易对注资（inject）。
一个交易对只能由该交易对的创建者来注资。注资不需要手续费。
注资需要指定一种token以及注资金额，TRON网络会自动根据当前交易对中两种token的比例，计算出另一个token所需的金额，从而保证注资前后，交易对中两个token的比例相同，价格没有变化。   与创建交易对相同，注资要求创建者拥有足够多的两种token的balance。</p>
<p>注资的合约是ExchangeInjectContract，该合约有3个参数：</p>
<ul>
<li>exchange_id，交易对的id</li>
<li>token_id，要注资的token的id</li>
<li>quant，要注资的token的金额</li>
</ul>
<p>例子：
我们对刚刚创建的abc与TRX的交易对进行注资，假设此交易对id为1（TRON网络中第1个交易对），当前交易对中abc balance为10000000，TRX balance为1000000，如果要增加10%的abc，则</p>
<div class="highlight"><pre><span></span><code>ExchangeInject<span class="w"> </span><span class="m">1</span><span class="w"> </span>abc<span class="w"> </span><span class="m">1000000</span>
</code></pre></div>
<p>如果成功，该交易会使得交易对中增加1000000个abc，并增加100000个TRX，交易对创建者的账户中abc和TRX的数量会相应地减少。</p>
<h2 id="_6">撤资<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>一个交易对中的所有资产都是创建者的。创建者可以随时撤资（withdraw），把交易对中的token赎回到自身账户中。一个交易对只能由该交易对的创建者来撤资。撤资不需要手续费。
和注资一样，撤资需要指定一种token以及撤资金额，TRON网络会自动根据当前交易对中两种token的比例，计算出另一个token撤资的金额，从而保证撤资前后，交易对中两个token的比例相同，价格没有变化。
撤资前后价格没有变化，但是价格波动会更大。</p>
<p>撤资的合约是ExchangeWithdrawContract，该合约有3个参数：</p>
<ul>
<li>exchange_id，交易对的id</li>
<li>token_id，要撤资的token的id</li>
<li>quant，要撤资的token的金额</li>
</ul>
<p>例子：
我们对之前创建的abc与TRX的交易对进行撤资，假设此交易对id为1，当前交易对中abc balance为10000000，TRX balance为1000000，如果要赎回10%的abc，则</p>
<div class="highlight"><pre><span></span><code>ExchangeWithdraw<span class="w"> </span><span class="m">1</span><span class="w"> </span>abc<span class="w"> </span><span class="m">1000000</span>
</code></pre></div>
<p>如果成功，该交易会使得交易对中减少1000000个abc，以及减少100000个TRX，交易对创建者的账户中abc和TRX的数量会相应地增加。</p>
<h2 id="_7">查询<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="1">1. 查询交易<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>有三个查询交易对的接口，包括：</p>
<p>查询所有交易对信息（ListExchanges）</p>
<p>分页查询交易对信息（GetPaginatedExchangeList）(Odyssey-v3.1.1暂不支持)</p>
<p>查询指定交易对信息（GetExchangeById）</p>
<p>相关api详情，请查询<a href="https://github.com/tronprotocol/Documentation/blob/master/%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/%E6%B3%A2%E5%9C%BA%E5%8D%8F%E8%AE%AE/%E6%B3%A2%E5%9C%BA%E9%92%B1%E5%8C%85RPC-API.md#64-%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%AE%9A%E4%BA%A4%E6%98%93%E5%AF%B9">波场RPC-API说明</a></p>
<h3 id="2">2. 计算当前价格<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>交易中token的当前价格信息的计算过程：</p>
<p>假设 first_token 当前的价格为 100 Sun，first_token_balance 为1,000,000, second_token_balance 为2,000,000，</p>
<p>second_token 当前的价格为 first_token * first_token_balance/second_token_balance = 50 Sun</p>
<h3 id="3-token">3. 计算交易获得token量<a class="headerlink" href="#3-token" title="Permanent link">&para;</a></h3>
<p>交易中花费first_token置换获得的second_token的数量的计算过程：</p>
<p>sellTokenQuant是要卖出的first_token的金额</p>
<p>buyTokenQuant是要买入的second_token的金额</p>
<p>supply = 1,000,000,000,000,000,000L</p>
<p>supplyQuant = -supply * (1.0 - Math.pow(1.0 + (double) sellTokenQuant/（firstTokenBalance + sellTokenQuant）, 0.0005))</p>
<p>buyTokenQuant = （long）balance * (Math.pow(1.0 + (double) supplyQuant / supply, 2000.0) - 1.0)</p>
<p>注意：由于网络其他账户发生交易，价格可能发生变化。</p>
<p>相关api详情，请查询<a href="../../api/http/">HTTP API</a>。</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../system-contracts/" class="btn btn-neutral float-left" title="系统合约"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../multi-signatures/" class="btn btn-neutral float-right" title="账户权限管理">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tronprotocol/documentation-zh" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../system-contracts/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../multi-signatures/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
